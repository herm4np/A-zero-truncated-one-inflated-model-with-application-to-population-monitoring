---
title: "EX"
author: "Herman Persson"
date: "null"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE)
```

```{r, include=FALSE}
library(starsExtra)
source("script_1.R")
```

# Introduktion

Okänd inflation i data är inte det mest vanligt förekommande problemet då det ofta kan försummas eller helt förebyggas. Men om en existerande inflation inte uppmärksammas kan det få stora konskvenser på en statistisk analys

Ett möjligt förekommande fel vid populationsskattning är att en redan observerad individ fel identifieras som en ny individ. Om detta fel förekommer så kommer den slutgiltiga datan innehålla falska observationer (spöken) som ger en inflation hos det antal individer som endast observerats en gång. 

# Metod

In the beginning of the chapter we will mainly focus on the poisson model which assumes that there is no individual heterogeneity. 

## The poisson model

### Truncated distributions

Suppose we have a population of size $N$ from which we receive samples and that we are able to distinguish from which individual each sample is from. If there is no individual heterogeneity and the probability that a sample comes from an individual is the same for all individuals in the population, then the number of samples per individual of the observed individuals will be zero-truncated poisson (positive poisson) distributed with probability mass function 

\begin{align}p_+(x; \lambda) = \frac{p(x; \lambda)}{1- p(0;\lambda)} = \frac{\lambda^x e^{-\lambda}}{(1-e^{-\lambda})x!} = \frac{\lambda^x}{(e^\lambda- 1)x!}.\end{align}

Now lets assume that for some reason a sample from one individual can be incorrectly identified as a sample from a not previously observed and non existent individual (ghost) with some probability $p$. For all $p$ bigger than zero this would result in an increased number of observed ones, so called one-inflation, as well as a decreased number of expected observations per individual. To incorporate these conditions into our model we consider the new probability mass function

\begin{align}p_{+1}(x;\lambda, p) = \begin{cases} (1 - \omega) + \omega p_+(x,\theta) \hspace{5mm}& \textrm{for } x = 1,\\ 
\omega p_+(x,\theta) & \textrm{for } x > 1. \end{cases}\end{align}

In this distrubution $\omega$ adjusts the extra mass at $x = 1$ and $\theta = \lambda(1-p)$ is adjusted density parameter with consideration to the reduced number of expected observation per individual. The expected number of extra ones generated by each individual 

$$\begin{align}&E[f_1] = Np(1, \theta) + N\lambda p\\
&E[f_n] = Np(n, \theta) + N\lambda p, \hspace{2mm} n \in (0,2,3,4,...)\\
\Rightarrow & p_{+1}(1, \lambda, p) = \frac{p(1, \theta) + \lambda p}{\lambda p + 1 - p(0, \theta)} = \frac{p(1, \theta)}{\lambda p + 1 - p(0, \theta)} + \frac{\lambda p}{\lambda p + 1 - p(0, \theta)} = \frac{p(1, \theta)}{\lambda p + 1 - p(0, \theta)} + (1 - \frac{1 + p(0, \theta)}{\lambda p + 1 - p(0, \theta)})\\
& p_{+1}(n, \lambda, p)\end{align} \\
\frac{1}{1 + \frac{\lambda p}{1 - p(0, \theta)}}$$

will be $p\lambda$ and therefore $\omega = 1/(1 + p\lambda)$. $p_{+1}$ is the probability mass function of the one-inflated positive poisson model (OIPP). If we denote the number of observations with value $i$ as $f_i$ and the highest observed value as $m$ we get the likelihood function 

$$L_{p_{+1}}(\lambda, p;x) = [(1- \omega) + p_+(1,\theta)]^{f_1} \prod_{i = 2}^{m} [\omega p_+(x_i,\theta)]^{f_i}.$$

If we are uninterested in the exact values of $p$ and $\lambda$ another useful way to look at data would be to ignore all the individuals observed only once and use a one-truncated positive poisson model (OTPP). By using this approach we will increase the uncertainty of our estimates but avoid some bias which can occur when using the OIPP model. In the case of the OTPP model we get the probability density function

$$p_{++}(x; \theta) = \frac{p(x; \theta)}{1- p(0;\theta) - p(1;\theta)} = \frac{\theta^x}{(e^{\theta} - \theta - 1)x!}, \hspace{5mm} x = 2, 3,...$$
with the corresponding likelihood function 

$$L_{p_{++}}(\theta;x) = \prod_{i = 2}^{m} p_{++}(x_i,\theta)^{f_i}.$$

The third and final poisson based distribution we will look at is positive poisson model (PP). The reason for this is for comparisons against our other two models, mainly to look at the effect on population estimates when existing inflation for some reason is not taken into account and to see how well our other models compare when there is no inflation, ie how well would our other models function as a precaution against possible inflation. The PP models probability mass function can be seen in (1) and its corresponding likelihood is 

$$L_{p_+} = \prod_{i = 1}^{m} p_{+}(x_i,\theta)^{f_i}$$

## Negative binomial model

### Base distrubution

By expanding our poisson model to a negative binomial model we will be able to account for individual heterogeneity. We can introduce individual heterogeneity for individual $i$ by letting the parameter of its poisson distrubution $\theta_i= \lambda_i(1-p)$ be distributed according to a Gamma distribution with shape parameter $\alpha = k\lambda$ and rate parameter $\beta = k/(1-p)$ where $k > 0$, ie

$$\theta_i = \lambda_i (1 - p) \sim \Gamma (k\lambda, \frac{k}{1-p}).$$

This means that $E[\theta_i] = \lambda(1-p)$ and $Var[\theta_i] = \lambda(1-p)^2/k$ and we are able to account for over dispersion and individual heterogenity by adjusting $k$. Due to ... we know that 

$$X_i \sim \Gamma (r, \frac{1-q}{q}) \hspace{5mm} \Rightarrow \hspace{5mm} Po(X_i) \stackrel{d}{=} NBin(r, q) $$

With some fairly easy calculations we then get 

\begin{align}\theta_i \sim \Gamma(k\lambda, \frac{k}{1-p}) \hspace{5mm} \Rightarrow \hspace{5mm} Po(\theta_i) \stackrel{d}{=} NBin(k\lambda,\frac{1-p}{1-p+k}).\end{align}

Notice that we can allow all $k > 0$ by using the extended negative binomial distribution which extends the binomial coefficient to all real-values by using the gamma function.

$$NBin(r, q) \sim \frac{\Gamma(x+r)}{x!\Gamma(r)}(1- q)^xq^r, \hspace{5mm}r>0,\hspace{3mm}0\leq q\leq 1, \hspace{3mm}x=0,1,...$$

### Truncated distributions

Let us denote the probability density function of our base distribution in (4) as $g(x;\lambda,k,p)$. Similar to the poisson model case we are going to use three different distributions for estimating the total population, the zero-truncated one-inflated negative binomial distribution (ZTOINB), zero and one-truncated negative binomial distribution (ZOTNB) and the zero-truncated negative binomial distribution (ZTNB). In the case of the last mentioned ZTNB distribution we assume that $p = 0$ and with size parameter $r = k\lambda$ and probability parameter $q = (1-p)/(1-p+k)$ get the probability density function 

$$g_+(x;\lambda, k,p\mid p=0) = \frac{g(x;\lambda, k, p\mid p =0)}{1 - g(0;\lambda, k, p\mid p =0)} = \frac{\frac{\Gamma(x+k\lambda)}{x!\Gamma(k\lambda)}\Big(1- \frac{1}{1+k}\Big)^x\Big(\frac{1}{1+k}\Big)^{k\lambda}}{1 - \Big(\frac{1}{1+k}\Big)^{k\lambda}}, \hspace{5mm} x = 1, 2,...$$

and in the ZOTNB model we get 

$$g_{++}(x;\lambda, k, p)=\frac{g(x;\lambda, k, p)}{1 - g(0;\lambda, k, p) - g(1;\lambda, k, p)} =\frac{\frac{\Gamma(x+k\lambda)}{x!\Gamma(k\lambda)}\Big(1- \frac{1-p}{1-p+k}\Big)^x\Big(\frac{1-p}{1+k-p}\Big)^{k\lambda}}{1-\Big(\frac{1-p}{1+k-p}\Big)^{k\lambda}-k\lambda\Big(1-\frac{1-p}{1+k-p}\Big)\Big(\frac{1-p}{1+k-p}\Big)^{k\lambda}}, \hspace{5mm} x = 2, 3,...$$

with $p$ in the interval $[0,1]$. In the case of the ZTOINB model we similarly to the OIPP model use our corresponding zero truncated distribution with the addition of $\omega$ to adjust the extra mass at 1. So we get the probability density function

$$g_{+1}(x;\lambda, k, p)=\begin{cases}(1-\omega)+\omega g_+(x;\lambda, k,p) \hspace{5mm}& \textrm{for } x = 1,\\ 
\omega g_+(x;\lambda, k,p)  &\textrm{for } x >1. \end{cases}$$

where $\omega = 1/(1+\lambda(1-p))$ just as the poisson model since $E[g_+] = \lambda(1-p)$ (see proof in appendix).

## Population estimation

For each one of our models we want to create an estimate of the total population $N$, which includes all the unobserved individuals. We denote the number of observed individuals (ghosts included) as $n$ and estimate the total population in the zero-truncated models which ignore inflation as

$$\hat{N}_{f+} = \frac{n}{1-f(0)}.$$

Where $f$ is our base distrubution and $f_+$ is the corresponding zero-truncated distrubution which ignores inflation. In the one-truncated models we use a similar estimator

$$\hat{N}_{f++} = \frac{n-f_1}{1-f(0)-f(1)},$$

where $f_1$ as before is the number of individuals observed once. In the case of the zero-truncated one-inflaited models we can use the estimator

\begin{align}\hat{N}_{f_{+1}} = \frac{n - f_1 + \hat{n}_1}{1 - f(0)}\end{align}

where $\hat{n}_1$ is the estimated number of real individuals observed once, ie not including ghosts. In (2) the proportion of real individuals observed once are $\omega p_+(1,\theta)$ and the proportion of ghosts are $1 - \omega$. Our estimator for $\hat{n}_1$ is therefor

$$\hat{n}_1 = f_1\Bigg(\frac{f_{+1}(1) - \mathbb{P}(\textrm{"ghost"})}{f_{+1}(1)} \Bigg) = f_1 \frac{\hat{\omega} f_+(1)}{(1 - \hat{\omega}) + \hat{\omega} f_+(1)}$$

which combined with (3) then gives us the estimator of $N$ as

$$\hat{N}_{f_{+1}} = \frac{n - f_1\bigg(1 - \frac{\hat{\omega} f_+(1)}{(1 - \hat{\omega}) + \hat{\omega} f_+(1)}\bigg)}{1 - p(0;\hat{\theta})}.$$

## Simulation

By doing a simulation study we will be able to analyse the bias of our estimators for different values of our model parameters. As an estimate for all parameters in our models we will be using the ML-estimates, and since some of the likelihoods cant be solved algebraically they will be maximized numerically. We will create confidence intervals for our estimators using our estimates arranged in order of magnitude.

## Application on bear data

The regions of Sweden which are habituated by brown bears are divided into four parts which are have all been monitored by the department of Environmental Research and Monitoring at the Swedish Museum of Natural History (NRM) since 2015. In each region, hunters are assigned test equipment every five years (maximum one region each year) to collect bear scat-samples, which are then sent to the NRM. These samples are used for genetic identification and NRM can then build up a database of bear individuals in the region. The number of times each bear was observed can be seen in figure 1.

```{r}
data_captures %>%
  group_by(year, id) %>%
  summarize(captured_bears = n()) %>%
  ggplot(aes(x = captured_bears)) + geom_histogram(binwidth = 1) + facet_grid(~year)
```

Just by observing the distrubtuion of capture times by year we are able to see that data look evenly distributed over the years. We can also see that most bears were observed just a few number of times and that the most common number of observations is one, for all five years. With our negative binomial models we will be able to see if there seems to be some kind of one inflaions happening aswell as be able to estimate the total number of bears each year.

# Resultat 

## Simultaions 

### Positive poisson model

To begin we simulate data from the one-inflated positive poisson (OIPP) distribution and estimate the population with the positive poisson (PP) model, which does not take into account that data is inflated. We simulate 1000 times from all combinations for 3 different population sizes, inflation parameter values and underlying distrubution paramers. For each simulation the undelying population size is estimated using the PP-model population estimator $N_{p_+}$ and the results can been seen in figure .... 

```{r}
P_SIM %>%
  group_by(lambda, p, N) %>%
  summarize(avg_N_est_percent_error = mean(N_est_pp)/N) %>%
  filter(N %in% c(500, 2500)) %>%
  ggplot(aes(x = p, y = avg_N_est_percent_error, group = as.factor(lambda), color = as.factor(lambda))) +
  geom_line() +
  scale_color_manual(values=c("red", "blue", "green")) +
  facet_grid(~N)
```

```{r}
P_SIM %>%
  pivot_longer(c(N_est_oipp, N_est_otpp, N_est_pp), names_to = "type", values_to = "N_est") %>%
  filter(type != "N_est_pp", p != 0.05, N == 500, lambda == 2)  %>%
  mutate(type = str_remove(type, "N_est_") %>% toupper(), N_est_2 = N_est/N) %>%
  arrange(N_est) %>%
  group_by(p, N, lambda, type) %>%
  summarise(N_mean_est = mean(N_est) %>% round(3), conf_90 = paste0("[", c(N_est[50], N_est[950]) %>% toString(), "]"), conf_99 = paste0("[", c(N_est[10], N_est[990]) %>% toString(), "]"), sd = sqrt(var(N_est)) %>% round(3)) %>% 
  knitr::kable()
```

## One truncated and inflated positive poisson models

To compare the population estimators of our one-inflated positive poisson (OIPP) and one-truncated positive poisson (OTPP) model we simulate 1000 times from all combinations for 3 different population sizes, inflation parameter values and underlying distrubution paramers. For each simulation the undelying population size is estimated using both the OIPP population estimator $N_{p_+1}$ and the OTPP population estimator $N_{p_++}$. The results of our simulations can be seen in figure ....

```{r}
par(mfrow=c(1,2))
P_SIM %>%
  group_by(lambda, p, N) %>%
  summarize(avg_N_est_percent_error = mean(N_est_oipp)/N) %>%
  ggplot(aes(x = p, y = avg_N_est_percent_error, group = as.factor(lambda), color = as.factor(lambda))) +
  geom_line() +
  scale_color_manual(values=c("red", "blue", "green")) +
  facet_grid(~N)
P_SIM %>%
  group_by(lambda, p, N) %>%
  summarize(avg_N_est_percent_error = mean(N_est_otpp)/N) %>%
  ggplot(aes(x = p, y = avg_N_est_percent_error, group = as.factor(lambda), color = as.factor(lambda))) +
  geom_line() +
  scale_color_manual(values=c("red", "blue", "green")) +
  facet_grid(~N)
```

### Negative binomial models


## Bear data

We want to know weather or not there seems to be one-inflation present when fitting our bear data to a Negative Binomial model. In tabel 

```{r}
data_frame(year = c("All", 2015, 2016, 2017, 2019, 2020), data = list(data_summary, data_summary_2015, data_summary_2016, data_summary_2017, data_summary_2019, data_summary_2020)) %>%
  rowwise() %>%
  mutate(n = length(data %>% pull(n_obs)),
         par_ZTOINB = list(data %>% pull(n_obs) %>% ztoinb_ml_fit())[[1]][1],
         par_ZOTNB = list(data %>% pull(n_obs) %>% zotnb_ml_fit())[[1]][1],
         par_ZTNB = list(data %>% pull(n_obs) %>% ztnb_ml_fit())[[1]][1],
         lambda_hat = par_ZTOINB[[1]] %>% round(2),
         k_hat = par_ZTOINB[[2]] %>% round(2),
         p_hat = par_ZTOINB[[3]] %>% round(2),
         N_ZTOINB = N_ztoinb(par_ZTOINB, data %>% pull(n_obs)),
         N_ZOTNB = N_zotnb(par_ZOTNB, data %>% pull(n_obs)),
         N_ZTNB = N_ztnb(par_ZTNB, data %>% pull(n_obs))) %>%
  select(year, n, lambda_hat, k_hat, p_hat, N_ZTOINB, N_ZOTNB, N_ZTNB) %>%
  knitr::kable()
```

TABLE BELOW SHOWS QQ-PLOT OF BEAR DATA WITH REMOVED ONES COMPARED TO THEORETICAL QUANTILES OF NEGBIN DISTRUBUTION WITH PARAMATERS ESTIMATED BY ZOTNB model

```{r}
par(mfrow=c(2,3))
qqplot(data_summary_2015$n_obs, qqplot_gen_2(data_summary_2015))
abline(0, 1, col = 'red')
qqplot(data_summary_2016$n_obs, qqplot_gen_2(data_summary_2016))
abline(0, 1, col = 'red')
qqplot(data_summary_2017$n_obs, qqplot_gen_2(data_summary_2017))
abline(0, 1, col = 'red')
qqplot(data_summary_2019$n_obs, qqplot_gen_2(data_summary_2019))
abline(0, 1, col = 'red')
qqplot(data_summary_2020$n_obs, qqplot_gen_2(data_summary_2020))
abline(0, 1, col = 'red')
qqplot(data_summary$n_obs, qqplot_gen_2(data_summary))
abline(0, 1, col = 'red')
```



# Diskussion

negativ inflation

# Appendix



# Referenser
